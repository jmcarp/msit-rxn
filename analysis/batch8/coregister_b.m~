function coregister_b

global CCN;

% Load mean functional image
meanfile = expandpath(CCN.ffiles, false, 1);
meanvol = spm_vol(meanfile);

% Copy anatomical image(s)
hrfile = expandpath(CCN.hrpat, false, 1);
copyfile(hrfile, fileprep(hrfile, 'reg'));
hrvol = spm_vol(fileprep(hrfile, 'reg'));

if CCN.coreg.twostage
    ovfile = expandpath(CCN.ovpat, false, 1);
    copyfile(ovfile, fileprep(ovfile, 'reg'));
    ovvol = spm_vol(fileprep(ovfile, 'reg'));
end

if CCN.coreg.twostage
    
    % Overlay to functional
    coreg(meanvol, ovvol);
    
    % High-res to overlay
    coreg(ovvol, hrvol);
    
else
    
    % High-res to functional
    coreg(meanvol, hrvol);
    
end

spm_check_registration(char({hrvol.fname, meanvol.fname}));
spm_print;

function coreg(tovol, fromvol)

% Estimation options
eopts = spm_get_defaults('coreg.estimate');
if isfield(CCN.coreg, 'eopts')
    eopts = catstruct(eopts, CCN.coreg.eopts);
end

% Write options
wopts = spm_get_defaults('coreg.write');
if isfield(CCN.coreg, 'wopts')
    wopts = catstruct(wopts, CCN.coreg.wopts);
end



x = spm_coreg(tovol, fromvol);
M = inv(spm_matrix(x));
MM = spm_get_space(fromvol.fname);
spm_get_space(fromvol.fname, M * MM);